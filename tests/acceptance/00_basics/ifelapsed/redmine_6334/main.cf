body common control
{
      inputs => { "../../../default.cf.sub" };
      bundlesequence  => { default("$(this.promise_filename)") };
      version => "1.0";
}

bundle agent test
{
  meta:
    "test_suppress_fail"
      string => "any",
      meta => { "redmine6334" };

  vars:
      "first"
        string =>
          execresult("/var/cfengine/bin/cf-agent -KIf $(this.promise_filename).sub -b example -Dfirst",
                     "noshell");

      "second"
        string =>
          execresult("/var/cfengine/bin/cf-agent -If $(this.promise_filename).sub -b example -Dsecond",
                     "noshell");

}

bundle agent check
{
  vars:
      "pass_strings" slist => { "test", "call_report_now" };
      "activations" slist => { "first", "second" };
      "pass_classes" slist => {
                              "pass_test_first",
                              "pass_call_report_now_first",
                              "pass_test_second",
                              "pass_call_report_now_second",
                              };

  classes:
      "pass_$(pass_strings)_$(activations)" expression => regcmp("^R: Called from $(pass_strings)",
                                                                 "$(activations)");

      "ok" and => { @(pass_classes) },
        comment => "I expect that all @(pass_classes) are defined, as each
                    promise specifically has ifelapsed set to 0.";

  reports:
    ok::
      "$(this.promise_filename) Pass";
    !ok::
      "$(this.promise_filename) FAIL";
}
