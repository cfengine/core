language: c
sudo: required

compiler:
  - gcc
# - clang
os:
  - linux
# - osx

addons:
  apt:
    packages:
  artifacts:
    paths:
    - artifacts/

env:
  global:
      # Quickest to build, fast performing, debugable builds.
    - CFLAGS="-g1 -O1"
      # upload log files, tarballs etc artifacts from the build.
    - ARTIFACTS_BUCKET=cfengine-travis-artifacts

#matrix:
#  include:

    # JOB 0  --  first because it's the fastest so we get quick feedback
    # - env: STYLE_CHECK_JOB=1

    # JOB 1
#    - env: CFLAGS="-g1 -O1"


before_install:
  - sudo apt-get -qq update
    # Needed to build
  - sudo apt-get install -y libssl-dev libpam0g-dev libtokyocabinet-dev
    # Optional
  - sudo apt-get install -y libxml2-dev libacl1-dev


script:
- INSTDIR=$HOME/cf_install
- cd $TRAVIS_BUILD_DIR

  # JOB 0
- if [ x$STYLE_CHECK_JOB = x1 ];
  then
      sh tests/style_check.sh;
      exit;
  fi

  # Fetch the tags from upstream, even if we are running on a foreign clone;
  # Needed for determine-version.py to work
- git remote add upstream https://github.com/cfengine/core.git;
  git fetch upstream 'refs/tags/*:refs/tags/*';

- NO_CONFIGURE=1 ./autogen.sh
- ./configure --enable-debug --with-tokyocabinet --prefix=$INSTDIR

- make dist
- export DIST_TARBALL=`echo cfengine-*.tar.gz`

- make

- make -C tests/unit check

- chmod -R go-w tests/acceptance
- make -C tests/acceptance check

# TODO tests in parallel jobs:
# 1. unit tests
# 2. default acceptance tests
# 3. unsafe acceptance tests

before_deploy:
# A tag ending with "number.number" is not a prerelease

- if echo $DIST_TARBALL | grep -E -q '[0-9]{1,2}\.[0-9]{1,2}\.tar\.gz';
  then
      IS_PRERELEASE=false;
  else
      IS_PRERELEASE=true;
  fi;
  export IS_PRERELEASE

deploy:
# We deploy when setting tags only, which basically never happens
# on master branch. Cherry-pick this part and alter it properly into
# the release branches.

  skip_cleanup: true
  provider: releases
  # Remember to set it as private variable in Travis-CI settings
  api_key: $GITHUB_RELEASE_TOKEN
# Does not work, I get the error that "true" is not a boolean
#  prerelease: $IS_PRERELEASE
  file:
  - "$DIST_TARBALL"
  on:
    tags: true
    # Avoid upload from all the multiple parallel matrix jobs
    condition: "$CF_VERSION = latest"


after_script:
- mkdir artifacts
- test "x$DIST_TARBALL" != x  &&  cp "$DIST_TARBALL" artifacts/
- gzip config.log  &&  mv config.log.gz artifacts/
- gzip tests/acceptance/summary.log  &&  mv tests/acceptance/summary.log.gz artifacts/acceptance_summary.log.gz
- gzip tests/acceptance/test.log     &&  mv tests/acceptance/test.log.gz    artifacts/acceptance.log.gz
- zip -r artifacts/acceptance_workdir.zip tests/acceptance/workdir
