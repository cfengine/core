body common control
{
  inputs => { "../default.cf.sub" };
  bundlesequence => { default("$(this.promise_filename)") };
}

bundle agent init
{
  commands:
# TODO add grep for GDB: !!! so that other references don't get found! :) :(
    "/bin/echo -n '=line_number=' && /bin/grep -n GDB:.*keep_promises_fail.cf $(this.promise_dirname)/../../../cf-serverd/server_transform.c | cut -d: -f1"
      contain => shell_command,
      module => "true";

  files:
    "$(sys.workdir)/keep_promises_fail.gdb"
      create => "true",
      edit_template => "$(this.promise_dirname)/keep_promises_fail.gdb.mustache",
      template_data => ' { "line_number": "$(echo.line_number)" } ',
      template_method => "mustache";
}

bundle agent test
{
  commands:
    "/bin/ls -l $(this.promise_dirname)/../../..";
    "/usr/bin/find $(this.promise_dirname)/../../.. -name 'server_transform.c'";
    "/bin/cat $(sys.workdir)/keep_promises_fail.gdb";

    "$(this.promise_dirname)/../../../libtool --mode=execute gdb -x $(sys.workdir)/keep_promises_fail.gdb --args $(this.promise_dirname)/../../../cf-serverd/cf-serverd --no-fork --file $(this.promise_dirname)/keep_promises_fail.cf.sub"
      classes => keptcode;
}

bundle agent check
{
  methods:
    "pass" usebundle => dcs_passif("ok", "$(this.promise_filename)");
}

body contain shell_command
{
  useshell => "useshell";
}

body classes keptcode
{
  kept_returncodes => { "255" };
  promise_kept => { "ok" };
}
