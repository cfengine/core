########################################################################
# Acceptance test framework.
#
# See README for details about writing test cases.
########################################################################

body file control
{
      # plucked.cf.sub comes from the stdlib with `make pluck`
      inputs => { "$(D.owndir)$(const.dirsep)plucked.cf.sub",
                  "$(D.owndir)$(const.dirsep)dcs.cf.sub",};
}

bundle common D
{
  vars:
      "owndir" string => "$(this.promise_dirname)";
}

bundle agent test_precheck
{
  vars:
      "test_skip_unsupported" slist => variablesmatching(".*_meta\.test_skip_unsupported");
      "test_skip_needs_work" slist => variablesmatching(".*_meta\.test_skip_needs_work");
      "test_suppress_fail" slist => variablesmatching(".*_meta\.test_suppress_fail");
      "test_suppress_fail_metatags" slist => getvariablemetatags("$(test_suppress_fail)");
      "test_suppress_fail_redmine" slist => filter("redmine.*", "test_suppress_fail_metatags", "true", "false", 1);

  classes:
      "test_skip_unsupported_set" expression => some(".*", "test_skip_unsupported");
      "test_skip_needs_work_set" expression => some(".*", "test_skip_needs_work");
      "test_suppress_fail_set" expression => some(".*", "test_suppress_fail");
      "test_suppress_fail_redmine_set" expression => some(".*", "test_suppress_fail_redmine");

      "test_skip_unsupported_match" and => { "test_skip_unsupported_set", "$($(test_skip_unsupported))" };
      "test_skip_needs_work_match" and => { "test_skip_needs_work_set", "$($(test_skip_needs_work))" };
      "test_suppress_fail_match" and => { "test_suppress_fail_set", "$($(test_suppress_fail))" };

      "proceed_with_test"
      and => { "!test_skip_unsupported_match", "!test_skip_needs_work_match" },
      scope => "namespace";

  reports:
    test_skip_unsupported_match::
      "$(this.promise_filename) Skip/unsupported";
    test_skip_needs_work_match::
      "$(this.promise_filename) Skip/needs_work";
    test_suppress_fail_match.test_suppress_fail_redmine_set::
      "$(this.promise_filename) XFAIL/$(test_suppress_fail_redmine)";
    test_suppress_fail_match.!test_suppress_fail_redmine_set::
      "$(this.promise_filename) FAIL/no_redmine_number";
}
